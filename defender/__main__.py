import os
import gzip
import pickle
import envparse
import _pickle as cPickle
from defender.model import Model
from defender.apps import create_app
from defender.models.ml import MLClassifier
import argparse

# CUSTOMIZE: import model to be used

def load_gzip_pickle(filename):
    fp = gzip.open(filename,'rb')
    obj = cPickle.load(fp)
    fp.close()
    return obj

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--model', type=str, default="ml_classifier.pkl", help='Turn on debug mode')
    args = parser.parse_args()

    # retrive config values from environment variables
    model_gz_path = envparse.env("MODEL_FILE", cast=str, default=args.model)

    # construct absolute path to ensure the correct model is loaded
    if not model_gz_path.startswith(os.sep):
        model_gz_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), model_gz_path)

    # CUSTOMIZE: app and model instance
    model = Model.load(model_gz_path)

    app = create_app(model)

    import sys
    port = int(sys.argv[1]) if len(sys.argv) == 2 else 8080

    print("Starting server...")

    from gevent.pywsgi import WSGIServer
    http_server = WSGIServer(('', port), app)
    http_server.serve_forever()

    # curl -XPOST --data-binary @somePEfile http://127.0.0.1:8080/ -H "Content-Type: application/octet-stream"
